Go to Agent and edit below file and add "<directories realtime="yes">/tmp</directories>" to it

/var/ossec/etc/ossec.conf

  <!-- File integrity monitoring -->
  <syscheck>
    <disabled>no</disabled>

    <!-- Frequency that syscheck is executed default every 12 hours -->
    <frequency>10</frequency>

    <scan_on_start>yes</scan_on_start>

    <!-- Directories to check  (perform all possible verifications) -->
    <directories>/etc,/usr/bin,/usr/sbin,/tmp</directories>
    <directories>/bin,/sbin,/boot</directories>
    <directories realtime="yes">/tmp</directories>


Go to wazuh server

a. Add the following rules to the /var/ossec/etc/rules/local_rules.xml file on the Wazuh server. These rules alert about changes in the /tmp directory that are detected by FIM scans:

    <group name="syscheck,pci_dss_11.5,nist_800_53_SI.7,">
        <!-- Rules for Linux systems -->
        <rule id="100200" level="7">
            <if_sid>550</if_sid>
            <field name="file">/tmp</field>
            <description>File modified in /tmp directory.</description>
        </rule>
        <rule id="100201" level="7">
            <if_sid>554</if_sid>
            <field name="file">/tmp</field>
            <description>File added to /tmp directory.</description>
        </rule>
    </group>


b. Add the following configuration to the Wazuh server /var/ossec/etc/ossec.conf file to enable the Virustotal integration. Replace <YOUR_VIRUS_TOTAL_API_KEY> with your VirusTotal API key. This allows to trigger a VirusTotal query whenever any of the rules 100200 and 100201 are triggered:

<ossec_config>
<integration>
    <name>virustotal</name>
    <api_key>81894784735951b1019236e8d6115c69f0eb26785644d07596d26db3ed491319</api_key> <!-- Replace with your VirusTotal API key -->
    <rule_id>100200,100201</rule_id>
    <alert_format>json</alert_format>
</integration>
</ossec_config>

## Generating your virustotal api key:

To get the VirusTotal API key, you should create an account in the virustotal.com. VirusTotal offers both free Public API with some limitations such as the limited number of requests per day and the rate of requests per minute and Private API for the premium accounts.

Once you have created your account, click in the right up menu -> API Key and copy your API Key

## Test the VirusTotal integration

We will download an EICAR test file to the /tmp directory on the agent side:
sudo curl -Lo /tmp/eicar.com https://secure.eicar.org/eicar.com


## Deleting malicious file from agents


Go to Wazuh agent

In this phase we will use the active response capability to delete the malicious file. Wazuh contains many default scripts for the active response like disabling account and blocking IP. In our case we should create a custom active response script to delete malicious files dropped in the /tmp directory. We will use the suggested script by wazuh POC guide.

Go to below path and do the following things

Create a file --> /var/ossec/active-response/bin/remove-threat.sh
Give file permission --> sudo chmod 750 /var/ossec/active-response/bin/remove-threat.sh
--> sudo chown root:wazuh /var/ossec/active-response/bin/remove-threat.sh
restart agent --> sudo systemctl restart wazuh-agent

Script data:

            #!/bin/bash

            LOCAL=`dirname $0`;
            cd $LOCAL
            cd ../

            PWD=`pwd`

            read INPUT_JSON
            FILENAME=$(echo $INPUT_JSON | jq -r .parameters.alert.data.virustotal.source.file)
            COMMAND=$(echo $INPUT_JSON | jq -r .command)
            LOG_FILE="${PWD}/../logs/active-responses.log"

            #------------------------ Analyze command -------------------------#
            if [ ${COMMAND} = "add" ]
            then
            # Send control message to execd
            printf '{"version":1,"origin":{"name":"remove-threat","module":"active-response"},"command":"check_keys", "parameters":{"keys":[]}}\n'

            read RESPONSE
            COMMAND2=$(echo $RESPONSE | jq -r .command)
            if [ ${COMMAND2} != "continue" ]
            then
            echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Remove threat active response aborted" >> ${LOG_FILE}
            exit 0;
            fi
            fi

            # Removing file
            rm -f $FILENAME
            if [ $? -eq 0 ]; then
            echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Successfully removed threat" >> ${LOG_FILE}
            else
            echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Error removing threat" >> ${LOG_FILE}
            fi

            exit 0;


This script uses the jq utility to parse json files. So we should install this utility with:

sudo apt update
sudo apt -y install jq


Go to the Wazuh server

Append the following blocks /var/ossec/etc/ossec.conf file. This enables Active Response and triggers the remove-threat.sh script when VirusTotal flags a file as malicious

    <ossec_config>
    <command>
        <name>remove-threat</name>
        <executable>remove-threat.sh</executable>
        <timeout_allowed>no</timeout_allowed>
    </command>

    <active-response>
        <disabled>no</disabled>
        <command>remove-threat</command>
        <location>local</location>
        <rules_id>87105</rules_id>
    </active-response>
    </ossec_config>

For more visibility on the progress of the active response actions (threat successfully removed or error removing threat) we can add the following rules (rule id: 100092, 100093) to the Wazuh server "/var/ossec/etc/rules/local_rules.xml" file to alert about the active response results:

    <group name="virustotal,">
    <rule id="100092" level="12">
        <if_sid>657</if_sid>
        <match>Successfully removed threat</match>
        <description>$(parameters.program) removed threat located at $(parameters.alert.data.virustotal.source.file)</description>
    </rule>

    <rule id="100093" level="12">
        <if_sid>657</if_sid>
        <match>Error removing threat</match>
        <description>Error removing threat located at $(parameters.alert.data.virustotal.source.file)</description>
    </rule>
    </group>


Tesing

Now we restart the Wazuh manager to apply the configuration changes and then we download the malicious EICAR test file.


sudo systemctl restart wazuh-manager

Go to agent and download --> sudo curl -Lo /tmp/eicar.com https://secure.eicar.org/eicar.com

We can see the following alerts triggered: in console:

· 100201 : File added to /tmp directory
· 87105 : VirusTotal: Alert — /tmp/eicar.com — 66 engines detected this file
· 553 : File deleted
· 100092 : active-response/bin/remove-threat.sh removed threat located at /tmp/eicar.com

If we examine the directory /tmp we will find that the file is already removed in wazuh agent


Slack integration


1. Created a workspace and new channel
2. · Create a Slack app: https://api.slack.com/apps?new_app=1, choose the option "From scratch" and fill the fields with the App Name : test Wazuh integration, and choose the workspace : Wazuh Integration, then create App
3. In the test Wazuh integration App -> Incoming Webhooks -> Activate Incoming Webhooks (on) -> Add New Webhook to Workspace
4. Go to wazuh server and edit the file --> /var/ossec/etc/ossec.conf

add below part

<ossec_config>
    <integration>
        <name>slack</name>
        <hook_url>https://hooks.slack.com/services/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</hook_url>
        <rule_id>87105,100092</rule_id>
        <alert_format>json</alert_format>
        <options>{"pretext": "Malware Detection"}</options> <!-- Replace with your custom JSON object -->
    </integration>
</ossec_config>

https://hooks.slack.com/services/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




https://medium.com/@benmansour.nejib/wazuh-detecting-removing-malware-and-alerting-using-fim-virustotal-active-response-and-slack-77dd0045a536